@startuml Secuencia Aplicar Filtro
!theme plain
skinparam backgroundColor #FFFFFF
skinparam shadowing false

title Secuencia: Aplicar Filtro de Enfermedad

actor Usuario
participant "CameraView" as View
participant "MainViewModel" as VM
participant "CameraService" as Camera
participant "CIProcessor" as Processor
participant "Screen" as Screen

Usuario -> View: Selecciona enfermedad\n(ej: Cataratas)
activate View

View -> VM: selectIllness(Illness)
activate VM
VM -> VM: selectedIllness = Cataracts
VM -> VM: Actualiza settings
VM --> View: Estado actualizado
deactivate VM

View --> Usuario: Muestra selección
deactivate View

Usuario -> View: Activa filtro
activate View

View -> VM: toggleFilter()
activate VM
VM -> VM: filterEnabled = true
VM --> View: Estado actualizado
deactivate VM

deactivate View

loop Cada frame de cámara
    Camera -> Camera: Captura frame
    activate Camera
    Camera -> View: Publica CGImage
    deactivate Camera
    
    activate View
    View -> Processor: apply(image, settings, centralFocus)
    activate Processor
    
    Processor -> Processor: Selecciona filtro\nsegún enfermedad
    
    alt Cataratas
        Processor -> Processor: applyCataracts()
    else Glaucoma
        Processor -> Processor: applyGlaucoma()
    else Degeneración Macular
        Processor -> Processor: applyMacularDegeneration()
    else Visión Túnel
        Processor -> Processor: applyTunnelVision()
    end
    
    Processor --> View: CGImage procesada
    deactivate Processor
    
    View -> Screen: Renderiza imagen
    activate Screen
    Screen --> Usuario: Muestra efecto\nen tiempo real
    deactivate Screen
    deactivate View
end

note right of Processor
  Los filtros se aplican a ~30 FPS
  usando Core Image para
  máximo rendimiento
end note

@enduml
