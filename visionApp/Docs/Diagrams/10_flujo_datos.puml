@startuml Flujo de Datos
!theme plain
skinparam backgroundColor #FFFFFF
skinparam shadowing false

title Flujo de Datos - Pipeline de Procesamiento

package "Captura" #E3F2FD {
  rectangle "AVCapture\nSession" as AVCapture
  rectangle "Video Output" as VideoOut
}

package "Conversión" #F3E5F5 {
  rectangle "CMSampleBuffer" as Buffer
  rectangle "CVPixelBuffer" as Pixel
  rectangle "CIImage" as CIImg
  rectangle "CGImage" as CGImg
}

package "Estado Global" #FFF3E0 {
  rectangle "MainViewModel" as MainVM {
    selectedIllness
    filterEnabled
    settings
    centralFocus
  }
}

package "Procesamiento" #E8F5E9 {
  rectangle "CIProcessor" as Processor {
    apply()
    --
    applyCataracts()
    applyGlaucoma()
    applyMacular()
    applyTunnel()
  }
  rectangle "Core Image\nFilters" as Filters
}

package "Renderizado" #FCE4EC {
  rectangle "CameraImageView" as ImageView
  rectangle "SwiftUI Canvas" as Canvas
}

package "Control" #E1F5FF {
  rectangle "Usuario" as User
  rectangle "FloatingMenu" as Menu
  rectangle "Voice Commands" as Voice
}

AVCapture --> VideoOut : frames
VideoOut --> Buffer : CMSampleBuffer
Buffer --> Pixel : extract
Pixel --> CIImg : convert
CIImg --> CGImg : render

CGImg --> ImageView : publish

User --> Menu : interact
User --> Voice : speak
Menu --> MainVM : update state
Voice --> MainVM : update state

MainVM --> Processor : provides settings

ImageView --> Processor : request filter
Processor --> Filters : apply CIFilters
Filters --> Processor : filtered image
Processor --> ImageView : CGImage

ImageView --> Canvas : render
Canvas --> User : display

note right of Processor
  Procesamiento en tiempo real
  • ~30 FPS
  • Core Image (GPU acelerado)
  • Filtros encadenados
end note

note right of MainVM
  Estado reactivo con Combine
  • @Published properties
  • ObservableObject
  • Actualización automática UI
end note

note left of User
  Entrada múltiple:
  • Touch (menú)
  • Voz (comandos)
  • Gestos (swipe)
end note

@enduml
